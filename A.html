<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCfolia 리플레이북 변환기</title>
    <link rel="icon" type="image/png" href="/trpgforkk/favicon.png">
    <!-- 폰트 로드 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@2.0/nanumsquare.css">
    
    <!-- 아이콘 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- 스타일 (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* 책 본문용 폰트 */
        @font-face {
            font-family: 'GounBatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/GowunBatang-Regular.woff') format('woff');
            font-weight: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'GounBatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/GowunBatang-Bold.woff') format('woff');
            font-weight: 700;
            font-display: swap;
        }

        :root {
            --font-ui: 'Inter', 'NanumSquare', sans-serif;
            --font-serif: 'GounBatang', serif;
            --font-sans: 'NanumSquare', sans-serif;
            --font-mono: 'Courier Prime', monospace;
            
            /* 기본값 A5 */
            --page-width: 148mm;
            --page-height: 210mm;
            --margin-top: 20mm;
            --margin-inner: 15mm; 
            --margin-outer: 12mm;
            --margin-bottom: 25mm; 
            --content-height: 165mm; 

            --font-size-body: 10.5pt;
            --line-height-body: 1.6;
        }

        /* UI 기본 스타일 (Clean White Theme) */
        body { 
            background-color: #f1f5f9; 
            color: #334155; 
            font-family: var(--font-ui);
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- 사이드바 스타일 --- */
        #sidebar {
            background: #ffffff;
            border-right: 1px solid #e2e8f0;
            box-shadow: none;
        }
        
        .sidebar-header { border-bottom: 1px solid #e2e8f0; background: #ffffff; }
        
        .section-label {
            font-size: 0.7rem; /* 텍스트 크기 축소 */
            font-weight: 800; /* 굵게 */
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .input-wrapper { margin-bottom: 1rem; }

        .ui-input {
            width: 100%;
            background-color: #fff;
            border: 1px solid #cbd5e1;
            border-radius: 0.25rem;
            padding: 0.4rem 0.6rem; /* 패딩 축소 */
            font-size: 0.8rem; /* 폰트 축소 */
            color: #334155;
            transition: all 0.2s;
            outline: none;
        }
        .ui-input:focus { border-color: #6366f1; }
        .ui-input::placeholder { color: #94a3b8; }

        /* 파일 입력 버튼 커스텀 */
        .custom-file-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 50px; /* 높이 축소 */
            border: 1px dashed #cbd5e1; border-radius: 6px;
            background-color: #f8fafc; color: #64748b;
            cursor: pointer; transition: all 0.2s;
            text-align: center; font-size: 0.75rem;
        }
        .custom-file-btn:hover { border-color: #6366f1; color: #6366f1; background-color: #eff6ff; }
        .custom-file-btn i { margin-bottom: 2px; }

        /* 토글 버튼 그룹 */
        .ui-toggle-group {
            display: flex;
            background-color: #f1f5f9;
            padding: 2px;
            border-radius: 0.3rem;
            border: 1px solid #e2e8f0;
        }
        .toggle-btn {
            flex: 1;
            padding: 0.25rem 0; /* 패딩 축소 */
            text-align: center;
            font-size: 0.75rem; /* 폰트 축소 */
            border-radius: 0.2rem;
            transition: all 0.2s;
            color: #64748b;
            cursor: pointer;
        }
        .toggle-btn.active {
            background-color: #fff;
            color: #0f172a;
            border: 1px solid #cbd5e1;
            font-weight: 700; /* 굵게 */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .toggle-btn:hover:not(.active) { color: #334155; background-color: #e2e8f0; }

        /* 사이드바 항목 라벨 (볼드 적용) */
        .input-wrapper > label { 
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.75rem; color: #475569; 
            margin-bottom: 0.25rem; font-weight: 800; /* Bold 효과 */
        }

        /* --- 책 페이지 스타일 (테두리/그림자 완전 제거) --- */
        .book-page {
            width: var(--page-width); 
            height: var(--page-height);
            background: white; 
            box-sizing: border-box;
            position: relative; 
            overflow: hidden; 
            margin: 0 auto;
            box-shadow: none;
            border: none; 
            display: none; 
            padding: var(--margin-top) var(--margin-outer) var(--margin-bottom) var(--margin-inner);
            color: #111; 
            transform-origin: center top;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        .book-page.active { display: block; }
        .book-page.cover-page { padding: 0 !important; }

        .page-number {
            position: absolute; bottom: 12mm; left: 0; width: 100%;
            text-align: center; font-size: 9pt; color: #64748b;
            font-family: var(--font-sans); font-weight: 500; z-index: 50;
        }

        .page-content {
            height: var(--content-height); overflow: hidden;
            display: flex; flex-direction: column; align-items: stretch;
        }

        /* --- 오버레이 & 모달 --- */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 100; display: none;
            justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        
        .modal-box {
            background: #fff; 
            border: 1px solid #e2e8f0;
            padding: 1.5rem; 
            border-radius: 0.75rem; 
            width: 360px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }

        /* 판정 예시 모달 */
        .preview-modal-box {
            width: 500px;
            max-width: 90vw;
            background: #f8fafc;
        }

        /* 편집 모드 하이라이트 */
        [contenteditable="true"] { outline: 1px dashed transparent; cursor: text; transition: all 0.2s; border-radius: 2px; }
        body.edit-mode-active [contenteditable="true"]:hover {
            background-color: rgba(99, 102, 241, 0.05);
            outline: 1px dashed #cbd5e1;
        }
        body.edit-mode-active [contenteditable="true"]:focus {
            outline: 1px solid #6366f1; 
            background-color: rgba(99, 102, 241, 0.05);
        }

        /* --- 인쇄 모드 --- */
        @media print {
            @page { margin: 0; size: auto; }
            body { background: white; margin: 0; }
            #sidebar, #preview-controls, #floating-toolbar, .no-print, .overlay { display: none !important; }
            #main-content { 
                display: block; padding: 0; margin: 0;
                height: auto; overflow: visible; background: transparent; width: 100%; 
            }
            [contenteditable="true"] { outline: none !important; background: none !important; }
            .book-page {
                display: block !important; margin: 0 !important;
                box-shadow: none !important; border: none !important;
                break-after: page; page-break-after: always;
                width: 100% !important; height: 100% !important;
                overflow: hidden !important;
            }
            .book-page:last-child { break-after: auto; }
        }

        /* --- 로그 콘텐츠 디자인 --- */
        .font-serif { font-family: var(--font-serif) !important; }
        .font-sans { font-family: var(--font-sans) !important; }
        
        .log-entry { margin-bottom: 1.2rem; break-inside: avoid; }
        
        .dialogue-box { display: flex; flex-direction: column; gap: 4px; }
        .dialogue-box .char-name {
            font-size: 9pt; font-weight: 700; color: #1e293b;
            margin-left: 2px; display: flex; align-items: center; gap: 6px;
        }
        .dialogue-box .char-name::before {
            content: ''; display: block; width: 3px; height: 3px;
            background-color: #334155; border-radius: 50%;
        }

        .dialogue-box.layout-side { flex-direction: row; gap: 16px; align-items: flex-start; }
        .dialogue-box.layout-side .char-name {
            width: 24mm; flex-shrink: 0; text-align: left; 
            justify-content: flex-start; margin: 0; padding-right: 0;
            border-right: 2px solid #e2e8f0; 
            font-size: 9pt; height: 100%;
        }
        .dialogue-box.layout-side .char-name::before { display: none; } 
        .dialogue-box.layout-side .dialogue-text { flex: 1; padding-left: 0; }
        
        .dialogue-text {
            line-height: var(--line-height-body); font-size: var(--font-size-body);
            color: #334155; padding-left: 2px; text-align: justify;
            word-break: keep-all; overflow-wrap: break-word;
        }
        .dialogue-text p { margin: 0; } 
        .dialogue-text p + p { margin-top: 0.3em; }

        .narration-box {
            color: #475569; padding: 0.5rem 0; margin: 1rem 0;
            line-height: var(--line-height-body); font-size: var(--font-size-body);
            position: relative; word-break: keep-all; overflow-wrap: break-word;
        }
        .narration-box.align-center { text-align: center; }
        .narration-box.align-left { text-align: left; padding-left: 0; border-left: none; }

        /* --- 판정 박스 디자인 (Refined & Ink-Saving) --- */
        .dice-container {
            width: 85%; margin: 1.5rem auto; 
            font-size: 9pt; background: #fff; color: #111;
            break-inside: avoid; text-align: center;
            position: relative; box-sizing: border-box;
        }
        /* 공통 헤더/바디 */
        .dice-header {
            padding: 6px 12px; font-weight: 700; font-family: var(--font-sans);
            text-align: center; letter-spacing: 0.02em; word-break: keep-all;
        }
        .dice-body {
            padding: 8px 12px; font-family: 'Courier Prime', 'NanumSquare', monospace;
            line-height: 1.5; font-size: 9.5pt; color: #333;
        }
        .dice-result-wrapper { text-align: center; padding-bottom: 10px; }
        .dice-result {
            display: inline-block; padding: 2px 10px;
            font-weight: 800; font-family: var(--font-sans); font-size: 9pt;
        }

        /* 1. Simple (기본) - 모던, 얇은 선 */
        .dice-container.style-default {
            border: 1px solid #cbd5e1; /* 아주 얇은 회색 선 */
            border-radius: 4px;
        }
        .dice-container.style-default .dice-header {
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
            font-size: 0.85rem;
        }
        .dice-container.style-default .dice-result {
            border: 1px solid #475569;
            border-radius: 100px;
            color: #1e293b;
        }

        /* 2. Memo (노트) - 타자기 감성 */
        .dice-container.style-memo {
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
            border-left: none; border-right: none;
            border-radius: 0;
            background: transparent;
        }
        .dice-container.style-memo .dice-header {
            font-family: 'Courier Prime', monospace;
            border-bottom: 1px dashed #ccc;
            font-weight: 400;
        }
        .dice-container.style-memo .dice-result {
            font-family: 'Courier Prime', monospace;
            text-decoration: underline;
            border: none;
            color: #000;
        }

        /* 3. Cyber (터미널) - 샤프함 */
        .dice-container.style-cyber {
            border: 1px solid #94a3b8;
            border-left: 4px solid #475569;
            border-radius: 0;
        }
        .dice-container.style-cyber .dice-header {
            text-align: left; padding-left: 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.8rem; color: #64748b;
        }
        .dice-container.style-cyber .dice-header::before { content: ":: "; color: #94a3b8; }
        .dice-container.style-cyber .dice-body { text-align: left; padding-left: 10px; font-weight: 700; }
        .dice-container.style-cyber .dice-result-wrapper { text-align: right; padding-right: 10px; }
        .dice-container.style-cyber .dice-result {
            border: 1px solid #475569;
            background: transparent; color: #1e293b;
            border-radius: 0;
        }

        /* 4. Fantasy (클래식) - 세리프 */
        .dice-container.style-fantasy {
            border: 1px solid #a8a29e;
            border-radius: 2px;
            outline: 1px solid #d6d3d1; /* 이중선 효과 */
            outline-offset: -3px;
        }
        .dice-container.style-fantasy .dice-header {
            font-family: var(--font-serif);
            border-bottom: 1px solid #e7e5e4;
            font-style: italic;
        }
        .dice-container.style-fantasy .dice-result {
            font-family: var(--font-serif);
            border-top: 1px solid #a8a29e;
            border-bottom: 1px solid #a8a29e;
            border-left: none; border-right: none;
            border-radius: 0;
            color: #44403c;
        }

        .system-box {
            font-size: 9.5pt; color: #64748b; text-align: center;
            border-top: 1px double #cbd5e1; border-bottom: 1px double #cbd5e1;
            padding: 6px 0; margin: 16px 0; 
            font-family: var(--font-mono); word-break: keep-all;
        }

        .cover-image { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); }
        
        #measure-container { 
            position: absolute; top: -9999px; left: -9999px; 
            width: calc(var(--page-width) - var(--margin-outer) - var(--margin-inner)); 
            visibility: hidden; box-sizing: border-box; font-family: var(--font-sans); 
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-indigo-100 selection:text-indigo-900">

    <!-- 사이드바 -->
    <aside id="sidebar" class="w-80 flex flex-col z-30 transition-transform duration-300">
        <div class="sidebar-header p-5 flex flex-col gap-1">
            <h1 class="text-lg font-bold flex items-center gap-2 text-slate-800 tracking-tight">
                <i data-lucide="book-open-check" class="text-indigo-600" size="20"></i> 
                TRPG Editor
            </h1>
            <p class="text-[10px] text-slate-400 font-medium pl-7">Replay Book Converter v14.0</p>
        </div>

        <div class="flex-1 overflow-y-auto px-5 py-4 space-y-6">
            
            <!-- 섹션 1: 파일 -->
            <div>
                <div class="section-label">
                    <i data-lucide="folder-open" size="12"></i> Source Files
                </div>
                <div class="grid grid-cols-2 gap-2 mb-1">
                    <div>
                        <label class="custom-file-btn" for="coverInput">
                            <i data-lucide="image" size="18"></i>
                            <span>표지</span>
                        </label>
                        <input type="file" id="coverInput" accept="image/*" class="hidden" onchange="handleFileSelect('coverInput')"/>
                    </div>
                    <div>
                        <label class="custom-file-btn" for="htmlInput">
                            <i data-lucide="file-text" size="18"></i>
                            <span>로그</span>
                        </label>
                        <input type="file" id="htmlInput" accept=".html" class="hidden" onchange="handleFileSelect('htmlInput')"/>
                    </div>
                </div>
                <!-- 표지 사이즈 안내 (요청사항) -->
                <p class="text-[10px] text-slate-400 text-center tracking-tight">
                    권장: A5(1748x2480) / 모바일(1080x1920)
                </p>
                <div id="file-status" class="text-[10px] text-indigo-500 mt-1 text-center h-3 font-bold"></div>
            </div>

            <!-- 섹션 2: 설정 -->
            <div>
                <div class="section-label">
                    <i data-lucide="sliders" size="12"></i> Preferences
                </div>

                <div class="input-wrapper">
                    <label>용지 크기</label>
                    <div class="ui-toggle-group">
                        <button id="sizeA5" class="toggle-btn active" onclick="setPageSize('A5')">A5 (책)</button>
                        <button id="sizeMobile" class="toggle-btn" onclick="setPageSize('Mobile')">모바일</button>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1 text-right" id="sizeHelperText">10.5pt / 1.6</p>
                </div>

                <div class="input-wrapper">
                    <label>
                        판정 박스 디자인
                        <button onclick="openPreviewModal()" class="text-slate-400 hover:text-indigo-500 transition-colors">
                            <i data-lucide="help-circle" size="12"></i>
                        </button>
                    </label>
                    <!-- 4개 한 줄 배열 (요청사항) -->
                    <div class="grid grid-cols-4 gap-1 bg-f1f5f9 p-0.5 border border-e2e8f0 rounded-[0.3rem]">
                        <button id="diceDefault" class="toggle-btn active" onclick="setDiceStyle('default')">기본</button>
                        <button id="diceMemo" class="toggle-btn" onclick="setDiceStyle('memo')">메모</button>
                        <button id="diceCyber" class="toggle-btn" onclick="setDiceStyle('cyber')">터미널</button>
                        <button id="diceFantasy" class="toggle-btn" onclick="setDiceStyle('fantasy')">고전</button>
                    </div>
                </div>
                
                <div class="input-wrapper">
                    <label>대사 레이아웃</label>
                    <div class="ui-toggle-group">
                        <button id="layoutVertical" class="toggle-btn active" onclick="setLayout('vertical')">상하(기본)</button>
                        <button id="layoutSide" class="toggle-btn" onclick="setLayout('side')">좌우(대본)</button>
                    </div>
                </div>

                <div class="input-wrapper">
                    <label>나레이션 이름 (지문 처리)</label>
                    <input type="text" id="narratorNameInput" placeholder="예: GM, system, ::" class="ui-input" onchange="reprocessLogs()">
                </div>

                <div class="input-wrapper">
                    <label>지문 정렬</label>
                    <div class="ui-toggle-group">
                        <button id="alignLeft" class="toggle-btn" onclick="setNarrationAlign('left')">왼쪽</button>
                        <button id="alignCenter" class="toggle-btn active" onclick="setNarrationAlign('center')">가운데</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div>
                        <label>대사 폰트</label>
                        <div class="ui-toggle-group">
                            <button id="diaSerif" class="toggle-btn" onclick="setFont('dialogue', 'serif')">명조</button>
                            <button id="diaSans" class="toggle-btn active" onclick="setFont('dialogue', 'sans')">고딕</button>
                        </div>
                    </div>
                    <div>
                        <label>지문 폰트</label>
                        <div class="ui-toggle-group">
                            <button id="narSerif" class="toggle-btn active" onclick="setFont('narration', 'serif')">명조</button>
                            <button id="narSans" class="toggle-btn" onclick="setFont('narration', 'sans')">고딕</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 하단 액션 버튼 -->
        <div class="p-5 border-t border-slate-100 bg-white grid grid-cols-2 gap-2">
            <button onclick="window.print()" class="flex justify-center items-center gap-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-3 rounded-md transition-all active:scale-95 text-xs">
                <i data-lucide="printer" size="14"></i> PDF
            </button>
            <button onclick="openEpubModal()" class="flex justify-center items-center gap-1.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-md transition-all active:scale-95 shadow-sm shadow-indigo-100 text-xs">
                <i data-lucide="book-down" size="14"></i> EPUB
            </button>
        </div>
    </aside>

    <!-- 메인 뷰어 -->
    <main id="main-content" class="flex-1 flex flex-col items-center bg-slate-100 relative h-full overflow-hidden">
        
        <!-- 플로팅 툴바 (상단) -->
        <div id="floating-toolbar" class="absolute top-6 z-20 flex gap-4 no-print pointer-events-auto">
            <!-- 편집 모드 토글 -->
            <div class="group relative">
                <button id="edit-btn" onclick="toggleEditMode()" class="bg-white text-slate-600 hover:text-indigo-600 p-2 rounded-full border border-slate-200 transition-all hover:scale-105 active:scale-95 shadow-sm">
                    <i data-lucide="pencil" size="18"></i>
                </button>
                <div class="absolute top-full mt-2 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-3 py-1.5 rounded-md opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                    편집 모드 (클릭하여 수정)
                </div>
            </div>

            <!-- 페이지 인디케이터 -->
            <div class="bg-white text-slate-600 px-4 py-1.5 rounded-full border border-slate-200 flex items-center gap-2 font-mono text-xs shadow-sm">
                <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Page</span>
                <input type="number" id="pageInput" value="1" min="1" class="w-8 text-center bg-transparent outline-none font-bold text-slate-800 border-b border-transparent focus:border-indigo-500 transition-colors" onchange="jumpToPage(this.value)">
                <span class="text-slate-400">/</span>
                <span id="totalPageLabel" class="text-slate-500">0</span>
            </div>
        </div>

        <!-- 책 렌더링 컨테이너 -->
        <div id="book-viewport" class="flex-1 w-full overflow-hidden flex items-center justify-center relative">
            
            <button onclick="changePage(-1)" id="btnPrev" class="absolute left-6 z-10 p-2 rounded-full text-slate-400 hover:text-indigo-600 hover:bg-white transition-all disabled:opacity-0">
                <i data-lucide="chevron-left" size="32"></i>
            </button>
            <button onclick="changePage(1)" id="btnNext" class="absolute right-6 z-10 p-2 rounded-full text-slate-400 hover:text-indigo-600 hover:bg-white transition-all disabled:opacity-0">
                <i data-lucide="chevron-right" size="32"></i>
            </button>

            <!-- 책 페이지 (배경 그림자 제거됨) -->
            <div id="book-container" class="relative transition-all duration-300">
                <div id="placeholder-page" class="book-page active flex flex-col justify-center items-center text-slate-300 bg-white" style="border: 1px dashed #cbd5e1;">
                    <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3">
                        <i data-lucide="file-up" size="28" class="text-slate-400"></i>
                    </div>
                    <p class="text-base font-bold text-slate-500">파일 업로드</p>
                    <p class="text-[10px] mt-1 text-slate-400">.html 로그 파일을 드래그하세요</p>
                </div>
            </div>
        </div>

        <!-- 측정용 (숨김) -->
        <div id="measure-container"></div>
    </main>

    <!-- 오버레이: 로딩 -->
    <div id="loading-overlay" class="overlay flex-col" style="display: none;">
        <div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col items-center shadow-lg">
            <div class="text-indigo-600 mb-3"><i data-lucide="loader-2" class="animate-spin" size="28"></i></div>
            <div class="text-slate-700 text-sm font-bold mb-2">변환 중입니다</div>
            <div class="progress-bar-container w-40 bg-slate-100 h-1 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-indigo-500 h-full w-0 transition-all duration-100"></div>
            </div>
            <div id="loading-text" class="text-slate-400 text-[10px] mt-2 font-mono">준비 중...</div>
        </div>
    </div>

    <!-- 오버레이: 판정 예시 모달 -->
    <div id="preview-modal" class="overlay" style="display: none;" onclick="closePreviewModal()">
        <div class="modal-box preview-modal-box p-6" onclick="event.stopPropagation()">
            <h2 class="text-slate-800 font-bold mb-5 text-center text-sm">판정 박스 디자인 예시</h2>
            <div class="grid grid-cols-1 gap-4">
                <!-- 기본 -->
                <div>
                    <p class="text-[10px] text-slate-400 font-bold mb-1 uppercase">기본 (Simple)</p>
                    <div class="dice-container style-default" style="width: 100%; margin: 0;">
                        <div class="dice-header">관찰력 판정</div>
                        <div class="dice-body">CC&lt;=50 (1D100&lt;=50)</div>
                        <div class="dice-result-wrapper"><span class="dice-result">성공</span></div>
                    </div>
                </div>
                <!-- 메모 -->
                <div>
                    <p class="text-[10px] text-slate-400 font-bold mb-1 uppercase">메모 (Memo)</p>
                    <div class="dice-container style-memo" style="width: 100%; margin: 0;">
                        <div class="dice-header">듣기 판정</div>
                        <div class="dice-body">CC&lt;=25 (1D100&lt;=25)</div>
                        <div class="dice-result-wrapper"><span class="dice-result">실패</span></div>
                    </div>
                </div>
                <!-- 사이버 -->
                <div>
                    <p class="text-[10px] text-slate-400 font-bold mb-1 uppercase">터미널 (Cyber)</p>
                    <div class="dice-container style-cyber" style="width: 100%; margin: 0;">
                        <div class="dice-header">해킹 시도</div>
                        <div class="dice-body">CC&lt;=80 (1D100&lt;=80)</div>
                        <div class="dice-result-wrapper"><span class="dice-result">성공</span></div>
                    </div>
                </div>
                <!-- 판타지 -->
                <div>
                    <p class="text-[10px] text-slate-400 font-bold mb-1 uppercase">고전 (Fantasy)</p>
                    <div class="dice-container style-fantasy" style="width: 100%; margin: 0;">
                        <div class="dice-header">마법 감지</div>
                        <div class="dice-body">CC&lt;=60 (1D100&lt;=60)</div>
                        <div class="dice-result-wrapper"><span class="dice-result">대성공</span></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-center cursor-pointer text-slate-400 text-xs hover:text-slate-600" onclick="closePreviewModal()">
                닫기
            </div>
        </div>
    </div>

    <!-- 오버레이: EPUB 모달 -->
    <div id="epub-modal" class="overlay" style="display: none;">
        <div class="modal-box shadow-xl bg-white p-6 rounded-xl w-[320px]">
            <h2 class="text-slate-800 font-bold mb-5 flex items-center gap-2 text-base">
                <i data-lucide="book-down" class="text-indigo-500" size="18"></i> EPUB 정보 입력
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">책 제목</label>
                    <input type="text" id="modal-title" class="ui-input" value="TRPG Replay Log">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">저자</label>
                    <input type="text" id="modal-author" class="ui-input" value="Unknown">
                </div>
                <div class="flex gap-2 mt-6">
                    <button onclick="closeEpubModal()" class="flex-1 py-2 rounded-md bg-slate-100 text-slate-600 text-xs font-bold hover:bg-slate-200">취소</button>
                    <button onclick="startEpubExport()" class="flex-1 py-2 rounded-md bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-500 shadow-sm">저장</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        /* 전역 변수 */
        const state = {
            pageSize: 'A5', 
            layout: 'vertical', 
            narrationAlign: 'center',
            fontDialogue: 'sans', 
            fontNarration: 'serif',
            diceStyle: 'default', 
            isEditMode: false
        };

        const elements = {
            htmlInput: document.getElementById('htmlInput'),
            coverInput: document.getElementById('coverInput'),
            narratorInput: document.getElementById('narratorNameInput'),
            bookContainer: document.getElementById('book-container'),
            measureContainer: document.getElementById('measure-container'),
            pageInput: document.getElementById('pageInput'),
            totalPageLabel: document.getElementById('totalPageLabel'),
            loadingOverlay: document.getElementById('loading-overlay'),
            progressBar: document.getElementById('progress-bar'),
            loadingText: document.getElementById('loading-text'),
            editBtn: document.getElementById('edit-btn'),
            epubModal: document.getElementById('epub-modal'),
            previewModal: document.getElementById('preview-modal')
        };
        
        let currentCoverData = null;
        let rawHtmlContent = "";
        let parsedLogs = [];
        let mergedLogs = [];
        let currentPageIndex = 0;
        let totalPages = 0;
        let MAX_CONTENT_HEIGHT_PX = 525; 

        /* 이벤트 핸들러 */
        function isOverlayVisible() {
            return elements.loadingOverlay.style.display !== 'none' || 
                   elements.epubModal.style.display !== 'none' ||
                   elements.previewModal.style.display !== 'none';
        }
        function isInputFocused() {
            const el = document.activeElement;
            return el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable);
        }

        document.addEventListener('keydown', (e) => {
            if (!state.isEditMode && !isOverlayVisible() && !isInputFocused()) {
                if (e.key === 'ArrowLeft') changePage(-1);
                else if (e.key === 'ArrowRight') changePage(1);
            }
        });

        let isScrolling = false;
        document.addEventListener('wheel', (e) => {
            if (state.isEditMode || isOverlayVisible() || isInputFocused()) return;
            if (isScrolling) return;
            if (e.deltaY > 50) { changePage(1); isScrolling = true; } 
            else if (e.deltaY < -50) { changePage(-1); isScrolling = true; }
            if (isScrolling) setTimeout(() => { isScrolling = false; }, 400);
        });

        /* 로딩 UI */
        function showLoading(show, message="변환 중...") {
            elements.loadingOverlay.style.display = show ? 'flex' : 'none';
            if (show) {
                elements.loadingText.innerText = message;
                updateLoading(0, 0);
            }
        }
        function updateLoading(percent, pageCount) {
            elements.progressBar.style.width = `${percent}%`;
            if (pageCount !== undefined && pageCount !== null) {
                elements.loadingText.innerText = `진행률: ${percent}% (페이지: ${pageCount})`;
            }
        }

        /* 모달 제어 */
        function openEpubModal() {
            if (mergedLogs.length === 0) { alert("먼저 로그 파일을 불러와주세요."); return; }
            elements.epubModal.style.display = 'flex';
        }
        function closeEpubModal() { elements.epubModal.style.display = 'none'; }
        function startEpubExport() { closeEpubModal(); exportEPUB(); }
        
        function openPreviewModal() { elements.previewModal.style.display = 'flex'; }
        function closePreviewModal() { elements.previewModal.style.display = 'none'; }

        /* 편집 모드 */
        function toggleEditMode() {
            state.isEditMode = !state.isEditMode;
            const btn = elements.editBtn;
            if (state.isEditMode) {
                btn.className = "bg-indigo-600 text-white p-2 rounded-full shadow-md border border-indigo-500 transition-all scale-110";
                document.body.classList.add('edit-mode-active');
            } else {
                btn.className = "bg-white text-slate-600 hover:text-indigo-600 p-2 rounded-full border border-slate-200 transition-all hover:scale-105 active:scale-95 shadow-sm";
                document.body.classList.remove('edit-mode-active');
            }
            const editables = elements.bookContainer.querySelectorAll('.char-name, .dialogue-text, .narration-box, .dice-line, .dice-body, .dice-result, .system-box');
            editables.forEach(el => el.contentEditable = state.isEditMode);
        }

        /* 설정 변경 */
        function updateToggleUI(groupId, activeValue) {
            if (groupId === 'diceStyle') {
                 ['default', 'memo', 'cyber', 'fantasy'].forEach(style => {
                     document.getElementById(`dice${style.charAt(0).toUpperCase() + style.slice(1)}`).className = 
                        `toggle-btn ${activeValue === style ? 'active' : ''}`;
                 });
                 return;
            }
            if(groupId==='size') {
                document.getElementById('sizeA5').className = `toggle-btn ${activeValue==='A5'?'active':''}`;
                document.getElementById('sizeMobile').className = `toggle-btn ${activeValue==='Mobile'?'active':''}`;
            } else if(groupId==='layout') {
                document.getElementById('layoutVertical').className = `toggle-btn ${activeValue==='vertical'?'active':''}`;
                document.getElementById('layoutSide').className = `toggle-btn ${activeValue==='side'?'active':''}`;
            } else if(groupId==='align') {
                document.getElementById('alignLeft').className = `toggle-btn ${activeValue==='left'?'active':''}`;
                document.getElementById('alignCenter').className = `toggle-btn ${activeValue==='center'?'active':''}`;
            } else if(groupId==='dia') {
                document.getElementById('diaSerif').className = `toggle-btn ${activeValue==='serif'?'active':''}`;
                document.getElementById('diaSans').className = `toggle-btn ${activeValue==='sans'?'active':''}`;
            } else if(groupId==='nar') {
                document.getElementById('narSerif').className = `toggle-btn ${activeValue==='serif'?'active':''}`;
                document.getElementById('narSans').className = `toggle-btn ${activeValue==='sans'?'active':''}`;
            }
        }

        function setDiceStyle(style) { state.diceStyle = style; updateToggleUI('diceStyle', style); if(mergedLogs.length > 0) reprocessLogs(); }
        function setLayout(mode) { state.layout = mode; updateToggleUI('layout', mode); if(mergedLogs.length > 0) reprocessLogs(); }
        function setNarrationAlign(align) { state.narrationAlign = align; updateToggleUI('align', align); if(mergedLogs.length > 0) reprocessLogs(); }
        function setFont(target, type) {
            if (target === 'dialogue') { state.fontDialogue = type; updateToggleUI('dia', type); } 
            else if (target === 'narration') { state.fontNarration = type; updateToggleUI('nar', type); }
            if(mergedLogs.length > 0) reprocessLogs();
        }

        function setPageSize(size) {
            state.pageSize = size;
            updateToggleUI('size', size);
            const root = document.documentElement;
            const sizeHelper = document.getElementById('sizeHelperText');

            if (size === 'A5') {
                root.style.setProperty('--page-width', '148mm');
                root.style.setProperty('--page-height', '210mm');
                root.style.setProperty('--content-height', '165mm');
                root.style.setProperty('--font-size-body', '10.5pt');
                root.style.setProperty('--line-height-body', '1.6');
                MAX_CONTENT_HEIGHT_PX = 525; 
                sizeHelper.innerText = "10.5pt / 1.6";
                injectPrintStyle('A5');
            } else {
                root.style.setProperty('--page-width', '108mm');
                root.style.setProperty('--page-height', '192mm');
                root.style.setProperty('--content-height', '147mm'); 
                root.style.setProperty('--font-size-body', '13pt'); 
                root.style.setProperty('--line-height-body', '1.55');
                MAX_CONTENT_HEIGHT_PX = 460; 
                sizeHelper.innerText = "13pt / 1.55";
                injectPrintStyle('108mm 192mm');
            }
            if(mergedLogs.length > 0) reprocessLogs();
        }

        function injectPrintStyle(size) {
            document.getElementById('print-style')?.remove();
            const style = document.createElement('style');
            style.id = 'print-style';
            if (size === 'A5') style.innerHTML = `@media print { @page { size: A5; margin: 0; } }`;
            else style.innerHTML = `@media print { @page { size: ${size}; margin: 0; } }`;
            document.head.appendChild(style);
        }

        /* --- 파일 처리 --- */
        function handleFileSelect(inputId) {
            const input = document.getElementById(inputId);
            const status = document.getElementById('file-status');
            
            if (input.files && input.files[0]) {
                const fileName = input.files[0].name;
                const parent = input.parentElement.querySelector('label');
                parent.style.borderColor = '#6366f1';
                parent.style.color = '#6366f1';
                parent.style.backgroundColor = '#eff6ff';
                
                if (inputId === 'coverInput') {
                    const reader = new FileReader();
                    reader.onload = (e) => { currentCoverData = e.target.result; reprocessLogs(); };
                    reader.readAsDataURL(input.files[0]);
                } else if (inputId === 'htmlInput') {
                    const reader = new FileReader();
                    reader.onload = (e) => { rawHtmlContent = e.target.result; reprocessLogs(); };
                    reader.readAsText(input.files[0]);
                    status.textContent = "로그 로드 완료";
                }
            }
        }

        function reprocessLogs() {
            if (!rawHtmlContent) return;
            if (state.isEditMode) { elements.editModeToggle.checked = false; toggleEditMode(); }
            showLoading(true);
            setTimeout(() => { parseLog(rawHtmlContent); }, 50);
        }

        /* --- 파싱 --- */
        const STRICT_DICE_PATTERNS = [ /CC\(\d+\)/i, /CC<=\d+/i, /\d+D\d+/i, /choice\[/i, /\d+\s*>\s*\d+/, /\d+\s*＞\s*\d+/ ];

        function getLogType(name, text, customNarrator) {
            const cleanName = name ? name.trim() : "";
            if (!cleanName || cleanName === '::' || cleanName === customNarrator) return 'narration';
            if (STRICT_DICE_PATTERNS.some(p => p.test(text))) return 'dice';
            if (cleanName.toLowerCase() === 'system' || cleanName.toLowerCase() === 'main') return 'system';
            return 'dialogue';
        }

        function parseLog(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const paragraphs = doc.querySelectorAll('p');
            const customNarrator = elements.narratorInput.value.trim();
            parsedLogs = [];

            paragraphs.forEach(p => {
                const spans = p.querySelectorAll('span');
                if (spans.length >= 3) {
                    let name = spans[1].textContent.trim();
                    let rawTextParts = [];
                    for (let i = 2; i < spans.length; i++) rawTextParts.push(spans[i].innerHTML);
                    let joinedText = rawTextParts.join('');
                    let text = joinedText.trim().replace(/<br\s*\/?>/gi, '\n'); 
                    let tempDiv = document.createElement("div"); tempDiv.innerHTML = text;
                    text = tempDiv.textContent || tempDiv.innerText || "";
                    let type = getLogType(name, text, customNarrator);
                    parsedLogs.push({ type, name, text });
                }
            });
            mergeLogs();
        }

        function mergeLogs() {
            mergedLogs = [];
            if (parsedLogs.length === 0) { showLoading(false); return; }
            let currentBlock = null;
            parsedLogs.forEach(log => {
                const logTextArray = Array.isArray(log.text) ? log.text : log.text.split('\n');
                if (log.type === 'dice' || log.type === 'system') {
                    if (currentBlock) { mergedLogs.push(currentBlock); currentBlock = null; }
                    mergedLogs.push({ ...log, text: logTextArray });
                    return;
                }
                if (currentBlock && currentBlock.name === log.name && currentBlock.type === log.type) {
                    currentBlock.text.push(...logTextArray);
                } else {
                    if (currentBlock) mergedLogs.push(currentBlock);
                    currentBlock = { type: log.type, name: log.name, text: logTextArray };
                }
            });
            if (currentBlock) mergedLogs.push(currentBlock);
            renderPaginatedBookAsync();
        }

        function formatDiceLog(logName, text) {
            const resultKeywords = ["보통 성공", "어려운 성공", "대단한 성공", "대성공", "대실패", "실패", "Success", "Failure", "Critical", "Fumble"];
            let resultLine = "";
            let bodyText = text;
            for (let kw of resultKeywords) {
                const regex = new RegExp(`(＞|>)s*${kw}\\s*$`, 'i');
                if (text.match(regex)) { resultLine = text.match(regex)[0].replace('＞', '').replace('>', '').trim(); bodyText = text.substring(0, text.lastIndexOf(text.match(regex)[0])); break; }
                else if (text.match(new RegExp(`${kw}\\s*$`, 'i'))) { resultLine = text.match(new RegExp(`${kw}\\s*$`, 'i'))[0]; bodyText = text.substring(0, text.lastIndexOf(resultLine)); break; }
            }
            bodyText = bodyText.replace(/(\(1D\d+)/g, '<br>$1').replace(/(\d+\s*[＞>]\s*\d+)/g, '<br>$1');
            let html = `<div class="dice-header">${logName}</div><div class="dice-body">${bodyText}</div>`;
            if (resultLine) html += `<div class="dice-result-wrapper"><span class="dice-result">${resultLine}</span></div>`;
            return html;
        }

        function createLogElement(log, isContinuation = false) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            if (log.type === 'narration') {
                const textHtml = log.text.map(t => `<p>${t}</p>`).join('');
                div.innerHTML = `<div class="narration-box align-${state.narrationAlign} font-${state.fontNarration}">${textHtml}</div>`;
            } else if (log.type === 'dice') {
                const rawText = log.text.join(' ');
                div.innerHTML = `<div class="dice-container style-${state.diceStyle}">${formatDiceLog(log.name, rawText)}</div>`;
            } else if (log.type === 'system') {
                const txt = log.text.join(' ');
                div.innerHTML = `<div class="system-box font-sans">${txt}</div>`;
            } else {
                const textHtml = log.text.map(t => `<p>${t}</p>`).join('');
                const layoutClass = state.layout === 'side' ? 'layout-side' : '';
                div.innerHTML = `<div class="dialogue-box ${layoutClass}"><span class="char-name font-sans">${log.name}</span><div class="dialogue-text font-${state.fontDialogue}">${textHtml}</div></div>`;
            }
            lucide.createIcons({ root: div });
            if (state.isEditMode) {
                const editables = div.querySelectorAll('.char-name, .dialogue-text, .narration-box, .dice-line, .dice-body, .dice-result, .system-box');
                editables.forEach(el => el.contentEditable = true);
            }
            return div;
        }

        async function renderPaginatedBookAsync() {
            elements.bookContainer.innerHTML = '';
            totalPages = 0;
            
            if (currentCoverData) {
                const coverPage = document.createElement('div');
                coverPage.className = 'book-page cover-page'; 
                coverPage.innerHTML = `<img src="${currentCoverData}" class="cover-image">`;
                elements.bookContainer.appendChild(coverPage);
                totalPages++; 
            } else {
                const titlePage = document.createElement('div');
                titlePage.className = 'book-page';
                titlePage.innerHTML = `<div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%;"><h1 class="font-serif text-3xl font-bold mb-4 border-b-2 border-slate-800 pb-2">LOG BOOK</h1><h2 class="font-sans text-sm text-slate-500 tracking-widest">TRPG REPLAY ARCHIVE</h2></div>`;
                elements.bookContainer.appendChild(titlePage);
                totalPages++;
            }

            let currentPageDiv = createNewPage();
            addPageNumber(currentPageDiv, totalPages + 1); 
            let pageContent = currentPageDiv.querySelector('.page-content');
            let currentHeight = 0;

            let queue = [...mergedLogs];
            let completedCount = 0;
            let initialTotal = queue.length; 

            const processChunk = () => {
                return new Promise((resolve) => {
                    const startTime = Date.now();
                    while (queue.length > 0 && Date.now() - startTime < 15) {
                        const log = queue.shift();
                        completedCount++; 
                        
                        let tempEl = createLogElement(log, log.isContinuation);
                        elements.measureContainer.appendChild(tempEl);
                        
                        const style = window.getComputedStyle(tempEl);
                        const margin = parseFloat(style.marginTop) + parseFloat(style.marginBottom);
                        let totalH = tempEl.offsetHeight + margin;
                        elements.measureContainer.removeChild(tempEl);

                        if (currentHeight + totalH <= MAX_CONTENT_HEIGHT_PX) {
                            pageContent.appendChild(tempEl); 
                            currentHeight += totalH;
                        } else {
                            if (currentHeight === 0) { pageContent.appendChild(tempEl); currentHeight += totalH; continue; }
                            const canSplit = (log.type === 'dialogue' || log.type === 'narration') && log.text.length > 1;

                            if (canSplit) {
                                let fitText = [];
                                let remainText = [...log.text];
                                let canFitAny = false;
                                let baseLog = { ...log, text: [] };
                                let baseEl = createLogElement(baseLog, log.isContinuation);
                                elements.measureContainer.appendChild(baseEl);
                                
                                let textBox = log.type === 'dialogue' ? baseEl.querySelector('.dialogue-text') : baseEl.querySelector('.narration-box');
                                const baseStyle = window.getComputedStyle(baseEl);
                                const baseMargin = parseFloat(baseStyle.marginTop) + parseFloat(baseStyle.marginBottom);

                                while(remainText.length > 0) {
                                    let nextParaText = remainText[0];
                                    let p = document.createElement('p');
                                    p.textContent = nextParaText;
                                    textBox.appendChild(p);
                                    if (currentHeight + baseEl.offsetHeight + baseMargin <= MAX_CONTENT_HEIGHT_PX) {
                                        fitText.push(remainText.shift());
                                        canFitAny = true;
                                    } else {
                                        textBox.removeChild(p);
                                        break;
                                    }
                                }
                                elements.measureContainer.removeChild(baseEl);

                                if (canFitAny && fitText.length > 0) {
                                    let fitLog = { ...log, text: fitText };
                                    pageContent.appendChild(createLogElement(fitLog, log.isContinuation));
                                    elements.bookContainer.appendChild(currentPageDiv);
                                    totalPages++;
                                    currentPageDiv = createNewPage();
                                    addPageNumber(currentPageDiv, totalPages + 1);
                                    pageContent = currentPageDiv.querySelector('.page-content');
                                    currentHeight = 0;
                                    if (remainText.length > 0) { queue.unshift({ ...log, text: remainText, isContinuation: true }); initialTotal++; }
                                } else {
                                    elements.bookContainer.appendChild(currentPageDiv);
                                    totalPages++;
                                    currentPageDiv = createNewPage();
                                    addPageNumber(currentPageDiv, totalPages + 1);
                                    pageContent = currentPageDiv.querySelector('.page-content');
                                    currentHeight = 0;
                                    queue.unshift(log); 
                                }
                            } else {
                                elements.bookContainer.appendChild(currentPageDiv);
                                totalPages++;
                                currentPageDiv = createNewPage();
                                addPageNumber(currentPageDiv, totalPages + 1);
                                pageContent = currentPageDiv.querySelector('.page-content');
                                currentHeight = 0;
                                queue.unshift(log); 
                            }
                        }
                    }
                    resolve(queue.length > 0);
                });
            };

            let hasMore = true;
            while (hasMore) {
                hasMore = await processChunk();
                let progress = 0;
                if(initialTotal > 0) progress = Math.min(99, Math.round(((completedCount) / (completedCount + queue.length)) * 100));
                updateLoading(progress, totalPages);
                await new Promise(r => setTimeout(r, 0));
            }
            if (pageContent.hasChildNodes()) { elements.bookContainer.appendChild(currentPageDiv); totalPages++; }
            elements.totalPageLabel.innerText = `/ ${totalPages}`;
            elements.pageInput.max = totalPages;
            currentPageIndex = 0;
            updatePageDisplay();
            setTimeout(() => showLoading(false), 300);
        }

        function createNewPage() {
            const page = document.createElement('div');
            page.className = 'book-page';
            const content = document.createElement('div');
            content.className = 'page-content';
            page.appendChild(content);
            return page;
        }
        function addPageNumber(pageDiv, pageNum) {
            const numDiv = document.createElement('div');
            numDiv.className = 'page-number';
            numDiv.textContent = `- ${pageNum} -`;
            pageDiv.appendChild(numDiv);
        }
        function updatePageDisplay() {
            const pages = document.querySelectorAll('.book-page');
            pages.forEach(p => p.classList.remove('active'));
            if (pages[currentPageIndex]) pages[currentPageIndex].classList.add('active');
            document.getElementById('btnPrev').disabled = currentPageIndex === 0;
            document.getElementById('btnNext').disabled = currentPageIndex === pages.length - 1;
            elements.pageInput.value = currentPageIndex + 1;
        }
        function changePage(delta) {
            const pages = document.querySelectorAll('.book-page');
            const newIndex = currentPageIndex + delta;
            if (newIndex >= 0 && newIndex < pages.length) { currentPageIndex = newIndex; updatePageDisplay(); }
        }
        function jumpToPage(val) {
            const pageNum = parseInt(val);
            const pages = document.querySelectorAll('.book-page');
            if (pageNum >= 1 && pageNum <= pages.length) { currentPageIndex = pageNum - 1; updatePageDisplay(); } else { elements.pageInput.value = currentPageIndex + 1; }
        }
        
        // Init
        setPageSize('A5');

        function saveFile(blob, fileName) {
            if (window.saveAs) { window.saveAs(blob, fileName); } else {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = fileName;
                document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(url); document.body.removeChild(a);
            }
        }

        async function exportEPUB() {
            const title = document.getElementById('modal-title').value.trim() || "TRPG Replay";
            const author = document.getElementById('modal-author').value.trim() || "Unknown";
            showLoading(true, "EPUB 생성 중...");
            const zip = new JSZip();
            zip.file("mimetype", "application/epub+zip", { compression: "STORE" });
            zip.file("META-INF/container.xml", `<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);
            const oebps = zip.folder("OEBPS");
            
            const cssContent = `body { font-family: sans-serif; line-height: 1.6; color: #111; } .log-entry { margin-bottom: 1em; } .char-name { font-weight: bold; display: block; margin-bottom: 0.2em; color: #111; } .dialogue-text { text-align: justify; color: #222; } .dialogue-text p { margin: 0; margin-bottom: 0.2em; } .narration-box { font-style: italic; text-align: center; color: #333; margin: 1em 0; } .narration-box p { margin: 0; margin-bottom: 0.2em; } .dice-container { border: 1px solid #999; padding: 0.5em; background: #fff; font-family: monospace; border-radius: 4px; } .dice-header { font-weight: bold; padding: 0.2em; border-bottom: 1px solid #ddd; text-align: center; color: #444; } .dice-body { padding: 0.5em; line-height: 1.4; text-align: center; color: #111; } .dice-body-line { display: block; } .dice-result { font-weight: bold; text-align: center; background: #fff; color: #000; border: 1px solid #000; border-radius: 12px; padding: 0.2em 0.8em; margin: 0 auto; display: block; width: fit-content; } .system-box { text-align: center; font-size: 0.9em; color: #555; border-top: 1px double #ccc; border-bottom: 1px double #ccc; padding: 0.5em 0; }`;
            oebps.file("style.css", cssContent);

            let xhtmlContent = `<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>${title}</title><link rel="stylesheet" type="text/css" href="style.css" /></head><body>`;
            mergedLogs.forEach(log => {
                let innerHTML = "";
                const textArray = Array.isArray(log.text) ? log.text : [log.text];
                const textParagraphs = textArray.map(t => `<p>${t}</p>`).join('\n');
                if (log.type === 'narration') innerHTML = `<div class="narration-box">\n${textParagraphs}\n</div>`;
                else if (log.type === 'dice') innerHTML = `<div class="dice-container">${formatDiceLog(log.name, Array.isArray(log.text) ? log.text.join(' ') : log.text)}</div>`;
                else if (log.type === 'system') innerHTML = `<div class="system-box">${Array.isArray(log.text) ? log.text.join(' ') : log.text}</div>`;
                else innerHTML = `<div class="log-entry">\n<span class="char-name">${log.name}</span>\n<div class="dialogue-text">\n${textParagraphs}\n</div>\n</div>`;
                xhtmlContent += innerHTML + "\n";
            });
            xhtmlContent += `</body></html>`;
            oebps.file("content.xhtml", xhtmlContent);

            const opfContent = `<?xml version="1.0" encoding="UTF-8"?><package xmlns="http://www.idpf.org/2007/opf" unique-identifier="BookID" version="2.0"><metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf"><dc:title>${title}</dc:title><dc:creator opf:role="aut">${author}</dc:creator><dc:language>ko</dc:language><dc:identifier id="BookID" opf:scheme="UUID">urn:uuid:${crypto.randomUUID()}</dc:identifier></metadata><manifest><item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/><item id="style" href="style.css" media-type="text/css"/><item id="content" href="content.xhtml" media-type="application/xhtml+xml"/></manifest><spine toc="ncx"><itemref idref="content"/></spine></package>`;
            oebps.file("content.opf", opfContent);
            const ncxContent = `<?xml version="1.0" encoding="UTF-8"?><ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1"><head><meta name="dtb:uid" content="urn:uuid:12345"/><meta name="dtb:depth" content="1"/><meta name="dtb:totalPageCount" content="0"/><meta name="dtb:maxPageNumber" content="0"/></head><docTitle><text>${title}</text></docTitle><navMap><navPoint id="navPoint-1" playOrder="1"><navLabel><text>Start</text></navLabel><content src="content.xhtml"/></navPoint></navMap></ncx>`;
            oebps.file("toc.ncx", ncxContent);

            try {
                const blob = await zip.generateAsync({ type: "blob" });
                saveFile(blob, `${title}.epub`);
            } catch (e) { alert("EPUB 실패: " + e.message); } 
            finally { showLoading(false); }
        }
    </script>
</body>
</html>
